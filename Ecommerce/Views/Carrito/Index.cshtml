@model Ecommerce.Dtos.CarritoDto

@{
    ViewData["Title"] = "Mi Carrito de Compras";
}

<div class="container mx-auto px-4 sm:px-6 lg:px-8 mt-8 md:mt-16">
    <h1 class="text-3xl font-extrabold text-white mb-8">@ViewData["Title"]</h1>

    <!-- Contenedor para el mensaje de "carrito vacío" -->
    <!-- Inicialmente oculto si hay items -->
    <div id="empty-cart-message" class="bg-gray-800 text-center p-12 rounded-lg" style="@(Model.Items.Any() ? "display: none;" : "display: block;")">
        <i class="fas fa-shopping-cart fa-4x text-gray-600 mb-4"></i>
        <h2 class="text-2xl font-bold text-white">Tu carrito está vacío</h2>
        <p class="text-gray-400 mt-2 mb-6">Parece que no has añadido nada a tu carrito.</p>
        <a asp-controller="Productos" asp-action="Index" class="inline-block bg-accent text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:opacity-90 transition duration-300">
            Ver Productos
        </a>
    </div>

    <!-- Contenedor principal del carrito (se oculta si está vacío) -->
    <div id="cart-container" class="flex flex-col lg:flex-row gap-12" style="@(Model.Items.Any() ? "display: flex;" : "display: none;")">

        <!-- Columna Izquierda: Lista de Items -->
        <div class="w-full lg:w-2/3" id="cart-list-section">
            <div class="bg-gray-800 rounded-lg shadow-lg">
                <!-- Usamos un id para poder escuchar clics dentro de la lista -->
                <ul role="list" class="divide-y divide-gray-700" id="cart-items-list">

                    @foreach (var item in Model.Items)
                    {
                        <!-- Añadimos un ID único a cada fila (li) -->
                        <li class="flex py-6 px-4 sm:px-6" id="cart-item-@item.ItemCarritoId">
                            <div class="flex-shrink-0">
                                @if (!string.IsNullOrEmpty(item.ImagenUrl))
                                {
                                    <img src="@item.ImagenUrl.Replace("\\", "/")"
                                         alt="@item.NombreProducto"
                                         class="w-24 h-24 rounded-md object-cover">
                                }
                                else
                                {
                                    <img src="https://placehold.co/100x100/1F2937/00e0b0?text=@item.NombreProducto"
                                         alt="@item.NombreProducto"
                                         class="w-24 h-24 rounded-md object-cover">
                                }
                            </div>

                            <div class="ml-4 flex-1 flex flex-col justify-between">
                                <div>
                                    <div class="flex justify-between text-base font-medium text-white">
                                        <h3>
                                            @item.NombreProducto
                                        </h3>
                                        <!-- Añadimos ID para el subtotal del item -->
                                        <p class="ml-4" id="subtotal-@item.ItemCarritoId">@item.Subtotal.ToString("C")</p>
                                    </div>
                                    <p class="mt-1 text-sm text-gray-400">Precio Unitario: @item.PrecioUnitario.ToString("C")</p>
                                </div>
                                <div class="flex-1 flex items-end justify-between text-sm">
                                    <p class="text-gray-400">Cantidad: @item.Cantidad</p>

                                    <div class="flex">
                                        <!--
                                            ¡BOTÓN ACTUALIZADO!
                                            - Añadida clase 'btn-remove-from-cart'
                                            - Añadido 'data-item-id'
                                        -->
                                        <button type="button"
                                                class="btn-remove-from-cart font-medium text-red-500 hover:text-red-400 transition duration-300"
                                                data-item-id="@item.ItemCarritoId">
                                            Eliminar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </li>
                    }

                </ul>
            </div>
        </div>

        <!-- Columna Derecha: Resumen del Pedido -->
        <div class="w-full lg:w-1/3" id="cart-summary-section">
            <div class="bg-gray-800 rounded-lg shadow-lg p-6 sticky top-24">
                <h2 class="text-lg font-medium text-white">Resumen del Pedido</h2>

                <dl class="mt-6 space-y-4">
                    <div class="flex items-center justify-between border-t border-gray-700 pt-4">
                        <dt class="text-2xl font-bold text-white">Total</dt>
                        <!-- Añadimos ID para el total general -->
                        <dd class="text-2xl font-bold text-accent" id="cart-total">@Model.TotalGeneral.ToString("C")</dd>
                    </div>
                </dl>

                <div class="mt-6">
                    <a asp-controller="Checkout" asp-action="Index" class="w-full flex items-center justify-center rounded-md border border-transparent bg-accent px-6 py-3 text-base font-bold text-white shadow-sm hover:opacity-90 transition duration-300">
                        Continuar con el Pago
                    </a>
                </div>
                <div class="mt-6 flex justify-center text-center text-sm text-gray-400">
                    <p>
                        o
                        <a asp-controller="Productos" asp-action="Index" class="font-medium text-accent hover:text-accent-hover">
                            Continuar Comprando
                            <span aria-hidden="true"> &rarr;</span>
                        </a>
                    </p>
                </div>
            </div>
        </div>

    </div>
</div>


<!--
    ¡¡NUEVA SECCIÓN DE SCRIPT!!
    Este script se inyectará en el _Layout.cshtml
-->
@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // 1. Escuchar clics en la lista de items
            const cartItemsList = document.getElementById('cart-items-list');
            if (cartItemsList) {
                cartItemsList.addEventListener('click', handleRemoveItem);
            }

            async function handleRemoveItem(event) {
                // 2. Comprobar si fue un botón "Eliminar"
                const button = event.target.closest('.btn-remove-from-cart');
                if (!button) {
                    return; // No fue el botón, no hacer nada
                }

                event.preventDefault();
                const itemCarritoId = button.dataset.itemId;

                // 3. Mostrar estado de carga
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                const payload = { itemCarritoId: parseInt(itemCarritoId) };

                try {
                    // 4. Llamar a la API de "remove"
                    const response = await fetch('/api/carrito/remove', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error('Error al eliminar el producto');
                    }

                    // 5. La API devuelve el CarritoDto actualizado
                    const updatedCart = await response.json();

                    // 6. Actualizar la UI sin recargar
                    updateCartPage(updatedCart, itemCarritoId);

                } catch (error) {
                    console.error('Error al eliminar:', error);
                    button.disabled = false;
                    button.innerHTML = 'Error';
                    setTimeout(() => { button.innerHTML = 'Eliminar'; }, 2000);
                }
            }

            // 7. Función helper para actualizar toda la página
            function updateCartPage(cart, removedItemId) {

                // a. Eliminar la fila (li) del DOM
                const itemRow = document.getElementById(`cart-item-${removedItemId}`);
                if (itemRow) {
                    itemRow.remove();
                }

                // b. Actualizar el Total General
                const totalElement = document.getElementById('cart-total');
                if (totalElement) {
                    // 'es-PE' para Soles Peruanos (S/)
                    totalElement.textContent = cart.totalGeneral.toLocaleString('es-PE', { style: 'currency', currency: 'PEN' });
                }

                // c. Actualizar el ícono del carrito en el HEADER
                const cartIconCount = document.getElementById('cart-item-count');
                let totalItems = 0;
                cart.items.forEach(item => {
                    totalItems += item.cantidad;
                });

                if (cartIconCount) {
                    if (totalItems > 0) {
                        cartIconCount.textContent = totalItems;
                        cartIconCount.style.display = 'flex';
                    } else {
                        cartIconCount.style.display = 'none';
                    }
                }

                // d. Comprobar si el carrito quedó vacío
                if (cart.items.length === 0) {
                    // Ocultar la lista y el resumen
                    document.getElementById('cart-container').style.display = 'none';
                    // Mostrar el mensaje de carrito vacío
                    document.getElementById('empty-cart-message').style.display = 'block';
                }
            }
        });
    </script>
}