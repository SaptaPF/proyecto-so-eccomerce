@model Ecommerce.Dtos.ProductoDto
@using System.Security.Claims

@{
    // 1. El título de la pestaña será el nombre del producto
    ViewData["Title"] = Model.Nombre;
}

<div class="container mx-auto px-4 sm:px-6 lg:px-8 my-16 md:my-24">

    <div class="flex flex-col md:flex-row gap-12">

        <div class="w-full md:w-1/2">
            @if (!string.IsNullOrEmpty(Model.ImagenUrl))
            {
                <img src="@Model.ImagenUrl.Replace("\\", "/")"
                     class="w-full img-fluid rounded-lg shadow-lg"
                     alt="Imagen de @Model.Nombre">
            }
            else
            {
                <img src="https://placehold.co/500x500/1F2937/00e0b0?text=@Model.Nombre"
                     class="w-full img-fluid rounded-lg shadow-lg"
                     alt="Imagen de @Model.Nombre">
            }
        </div>

        <div class="w-full md:w-1/2">
            <h1 class="text-4xl font-extrabold text-white">@Model.Nombre</h1>

            <div class="flex items-center mt-3">
                @await Html.PartialAsync("_RatingStarsPartial", Model.AverageRating)
                <span class="ml-3 text-sm text-gray-400">(@Model.ReviewCount reseñas)</span>
            </div>

            <h2 class="text-accent text-5xl font-bold my-4">@Model.Precio.ToString("C")</h2>

            <div class="my-4">
                @if (Model.Stock > 10)
                {
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-900 text-green-200">
                        <i class="fas fa-check-circle mr-2"></i> En Stock
                    </span>
                }
                else if (Model.Stock > 0)
                {
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-900 text-yellow-200">
                        <i class="fas fa-exclamation-triangle mr-2"></i> ¡Últimas @Model.Stock unidades!
                    </span>
                }
                else
                {
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-900 text-red-200">
                        <i class="fas fa-times-circle mr-2"></i> Agotado
                    </span>
                }
            </div>

            <h4 class="mt-6 text-xl font-semibold text-white">Descripción</h4>
            <p class="mt-2 text-gray-300 text-lg leading-relaxed">@Model.Descripcion</p>

            <h5 class="mt-6 text-lg font-semibold text-white">Categorías</h5>
            <div class="flex flex-wrap gap-2 mt-2">
                @foreach (var categoriaNombre in Model.NombresCategorias)
                {
                    <span class="px-3 py-1 bg-gray-700 text-gray-200 text-sm font-medium rounded-full">@categoriaNombre</span>
                }
            </div>

            <hr class="border-gray-700 my-8">

            <div class="d-grid gap-2">
                <button data-producto-id="@Model.ProductoId"
                        class="btn-add-to-cart w-full bg-accent text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:opacity-90 transition duration-300 text-lg"
                        disabled="@(Model.Stock <= 0)">

                    @if (Model.Stock > 0)
                    {
                        <span><i class="fas fa-cart-plus mr-2"></i> Añadir al Carrito</span>
                    }
                    else
                    {
                        <span><i class="fas fa-times-circle mr-2"></i> Agotado</span>
                    }
                </button>
            </div>

            <div class="mt-4">
                <a asp-controller="Productos" asp-action="Index" class="text-accent hover:text-accent-hover transition duration-300">
                    &larr; Volver al catálogo
                </a>
            </div>
        </div>
    </div>

    <hr class="border-gray-700 my-16">

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">

        <div>
            <h3 class="text-2xl font-bold text-white mb-6">Opiniones de Clientes (@Model.ReviewCount)</h3>

            @if (Model.Resenas != null && Model.Resenas.Any())
            {
                <div class="space-y-6">
                    @foreach (var review in Model.Resenas.OrderByDescending(r => r.Rating))
                    {
                        <div class="bg-gray-800 p-6 rounded-lg shadow">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-sm text-white font-bold mr-3 border border-gray-600">
                                        @review.InicialesCliente
                                    </div>
                                    <span class="font-semibold text-white">@review.NombreCliente</span>
                                </div>
                                <div class="flex text-accent text-sm">
                                    @await Html.PartialAsync("_RatingStarsPartial", (double)review.Rating)
                                </div>
                            </div>
                            <p class="text-gray-300 text-sm leading-relaxed">@review.Comentario</p>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="bg-gray-800 p-8 rounded-lg text-center">
                    <i class="far fa-comment-dots text-4xl text-gray-600 mb-3"></i>
                    <p class="text-gray-400 italic">Este producto aún no tiene reseñas.</p>
                    <p class="text-accent font-medium mt-2">¡Sé el primero en opinar!</p>
                </div>
            }
        </div>

        <div>
            <div class="bg-gray-800 p-8 rounded-lg shadow-lg sticky top-24 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-6">Escribe tu opinión</h3>

                @if (User.Identity.IsAuthenticated)
                {
                    @if (TempData["Success"] != null)
                    {
                        <div class="mb-4 p-3 bg-green-900 text-green-200 rounded text-sm border border-green-700 flex items-center">
                            <i class="fas fa-check-circle mr-2"></i> @TempData["Success"]
                        </div>
                    }
                    @if (TempData["Error"] != null)
                    {
                        <div class="mb-4 p-3 bg-red-900 text-red-200 rounded text-sm border border-red-700 flex items-center">
                            <i class="fas fa-exclamation-circle mr-2"></i> @TempData["Error"]
                        </div>
                    }

                    <form asp-action="AddReview" method="post">
                        <input type="hidden" name="ProductoId" value="@Model.ProductoId" />

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Tu Calificación</label>
                            <div class="flex flex-row-reverse justify-end gap-1">
                                @for (int i = 5; i >= 1; i--)
                                {
                                    <input type="radio" id="star@(i)" name="Rating" value="@i" class="peer hidden" required />
                                    <label for="star@(i)" class="cursor-pointer text-gray-600 peer-checked:text-yellow-400 peer-hover:text-yellow-400 hover:text-yellow-400 text-2xl transition-colors duration-200">
                                        <i class="fas fa-star"></i>
                                    </label>
                                }
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Tu Comentario</label>
                            <textarea name="Comentario" rows="4" class="w-full bg-gray-900 border border-gray-600 rounded-md text-white p-3 focus:ring-accent focus:border-accent placeholder-gray-500" placeholder="¿Qué te pareció el producto? ¿Lo recomendarías?" required></textarea>
                        </div>

                        <button type="submit" class="w-full bg-accent text-black font-bold py-3 px-4 rounded hover:opacity-90 transition duration-300">
                            Publicar Reseña
                        </button>
                    </form>
                }
                else
                {
                    <div class="text-center py-8">
                        <i class="fas fa-lock text-gray-500 text-4xl mb-4"></i>
                        <p class="text-gray-300 mb-6">Debes iniciar sesión para poder escribir una reseña.</p>
                        <a href="/Identity/Account/Login?returnUrl=@Context.Request.Path" class="inline-block w-full bg-gray-700 text-white px-4 py-3 rounded hover:bg-gray-600 transition duration-300 font-medium">
                            Iniciar Sesión
                        </a>
                    </div>
                }
            </div>
        </div>

    </div>
</div>