@model Ecommerce.Dtos.CheckoutViewModel

@{
    ViewData["Title"] = "Finalizar Compra";
    // Convertimos el total a string con formato punto decimal para JS (ej. "100.50")
    // PayPal suele requerir USD, EUR, etc. Si usas PEN, asegúrate que tu cuenta lo soporte o cambia la moneda.
    string totalParaPayPal = Model.Carrito.TotalGeneral.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture);
}

<div class="container mx-auto px-4 sm:px-6 lg:px-8 mt-8 md:mt-16">
    <h1 class="text-3xl font-extrabold text-white mb-8">@ViewData["Title"]</h1>

    <div class="flex flex-col lg:flex-row gap-12">

        <!-- Columna Izquierda: Direcciones -->
        <div class="w-full lg:w-2/3">

            <!-- FORMULARIO 1: CREAR PEDIDO -->
            <!-- Le ponemos un ID 'order-form' para poder enviarlo desde JS -->
            <form id="order-form" asp-controller="Checkout" asp-action="PlaceOrder" method="post">
                @Html.AntiForgeryToken()

                <!-- Sección 1: Direcciones Guardadas -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-white mb-4">Seleccionar Dirección de Envío</h2>

                    @if (Model.DireccionesGuardadas.Any())
                    {
                        <fieldset class="space-y-4">
                            <legend class="sr-only">Direcciones</legend>
                            @foreach (var direccion in Model.DireccionesGuardadas)
                            {
                                <div class="relative flex items-start bg-gray-700 p-4 rounded-lg border border-gray-600">
                                    <div class="flex items-center h-5">
                                        <input id="direccion-@direccion.DireccionId" name="direccionId" type="radio" value="@direccion.DireccionId" class="focus:ring-accent h-4 w-4 text-accent border-gray-500 bg-gray-600" checked="@(Model.DireccionesGuardadas.First() == direccion ? "checked" : null)">
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="direccion-@direccion.DireccionId" class="font-medium text-white">
                                            @direccion.Calle, @direccion.Ciudad
                                        </label>
                                        <p class="text-gray-400">@direccion.Estado, @direccion.CodigoPostal</p>
                                    </div>
                                </div>
                            }
                        </fieldset>
                    }
                    else
                    {
                        <p class="text-gray-400">No tienes direcciones guardadas. Por favor, añade una nueva.</p>
                        <!-- Campo oculto para validación si no hay dirección -->
                        <input type="hidden" id="no-address-flag" value="true" />
                    }
                </div>

                <!--
                   CAMBIO: Ya no mostramos el botón de "Confirmar" directamente aquí.
                   Los botones de PayPal estarán en la columna derecha (Resumen).
                -->

            </form>

            <!-- FORMULARIO 2: NUEVA DIRECCIÓN -->
            <h3 class="text-xl font-semibold text-white mt-8 mb-4">O Añadir Nueva Dirección</h3>
            <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                <form asp-controller="Checkout" asp-action="Index" method="post" class="space-y-4">
                    @Html.AntiForgeryToken()
                    <div>
                        <label asp-for="NuevaDireccion.Calle" class="block text-sm font-medium text-gray-300">Calle y Número</label>
                        <input asp-for="NuevaDireccion.Calle" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-accent focus:border-accent" />
                        <span asp-validation-for="NuevaDireccion.Calle" class="text-red-400 text-sm"></span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label asp-for="NuevaDireccion.Ciudad" class="block text-sm font-medium text-gray-300">Ciudad</label>
                            <input asp-for="NuevaDireccion.Ciudad" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-accent focus:border-accent" />
                            <span asp-validation-for="NuevaDireccion.Ciudad" class="text-red-400 text-sm"></span>
                        </div>
                        <div>
                            <label asp-for="NuevaDireccion.Estado" class="block text-sm font-medium text-gray-300">Estado / Provincia</label>
                            <input asp-for="NuevaDireccion.Estado" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-accent focus:border-accent" />
                            <span asp-validation-for="NuevaDireccion.Estado" class="text-red-400 text-sm"></span>
                        </div>
                        <div>
                            <label asp-for="NuevaDireccion.CodigoPostal" class="block text-sm font-medium text-gray-300">Código Postal</label>
                            <input asp-for="NuevaDireccion.CodigoPostal" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-accent focus:border-accent" />
                            <span asp-validation-for="NuevaDireccion.CodigoPostal" class="text-red-400 text-sm"></span>
                        </div>
                    </div>
                    <div class="pt-4 text-right">
                        <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gray-600 hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent">
                            Guardar Dirección
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Columna Derecha: Resumen y PAGO -->
        <div class="w-full lg:w-1/3">
            <div class="bg-gray-800 rounded-lg shadow-lg p-6 sticky top-24">
                <h2 class="text-lg font-medium text-white">Resumen del Pedido</h2>

                <ul role="list" class="divide-y divide-gray-700 mt-6">
                    @foreach (var item in Model.Carrito.Items)
                    {
                        <li class="flex py-4">
                            <div class="flex-shrink-0">
                                <img src="https://placehold.co/80x80/1F2937/00e0b0?text=@item.NombreProducto[0]" alt="@item.NombreProducto" class="w-20 h-20 rounded-md object-cover">
                            </div>
                            <div class="ml-4 flex-1 flex flex-col">
                                <div>
                                    <h4 class="text-base font-medium text-white">@item.NombreProducto</h4>
                                    <p class="mt-1 text-sm text-gray-400">Cantidad: @item.Cantidad</p>
                                </div>
                                <div class="flex-1 flex items-end justify-between text-sm">
                                    <p class="text-gray-300">@item.PrecioUnitario.ToString("C")</p>
                                    <p class="font-medium text-white">@item.Subtotal.ToString("C")</p>
                                </div>
                            </div>
                        </li>
                    }
                </ul>

                <dl class="mt-6 space-y-4 border-t border-gray-700 pt-6">
                    <div class="flex items-center justify-between text-2xl font-bold text-white">
                        <dt>Total</dt>
                        <dd class="text-accent">@Model.Carrito.TotalGeneral.ToString("C")</dd>
                    </div>
                </dl>

                <!-- AQUÍ VAN LOS BOTONES DE PAGO -->
                <div class="mt-8">
                    <!-- Contenedor para PayPal -->
                    <div id="paypal-button-container"></div>
                </div>

            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <!--
       1. SCRIPT DE PAYPAL
       Reemplaza 'sb' (Sandbox) por tu Client ID real de PayPal Developer.
       IMPORTANTE: currency=USD porque PayPal a veces da problemas con monedas locales en modo prueba.
       Si quieres usar PEN, cambia currency=PEN (y asegúrate que tu cuenta sandbox lo soporte).
    -->
    <script src="https://www.paypal.com/sdk/js?client-id=AQjPuFRT2L4FGyBo14zHyZd_Ip4maf8aDFb1Qy72fTAYnJuyGqygS_OBPIol91SSBzyDxbUOVb6OuLCT&currency=USD"></script>

    <script>
        // Obtenemos el total desde C# para usarlo en JS
        const totalAmount = "@totalParaPayPal";

        paypal.Buttons({
            style: {
                layout: 'vertical',
                color:  'gold',
                shape:  'rect',
                label:  'paypal'
            },

            // 1. Crear la orden en PayPal
            createOrder: function(data, actions) {
                // Validar que haya una dirección seleccionada antes de abrir PayPal
                const selectedAddress = document.querySelector('input[name="direccionId"]:checked');
                const noAddressFlag = document.getElementById('no-address-flag');

                if (!selectedAddress && !noAddressFlag) { // Si hay direcciones pero ninguna seleccionada
                     alert("Por favor selecciona una dirección de envío.");
                     return; // Detiene el proceso
                }
                if (noAddressFlag) {
                     alert("Por favor añade una dirección de envío primero.");
                     return;
                }

                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: totalAmount // El precio total de tu carrito
                        }
                    }]
                });
            },

            // 2. Cuando el usuario paga exitosamente en el popup
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(details) {

                    // Muestra un mensaje de éxito (opcional)
                    // alert('Pago completado por ' + details.payer.name.given_name);

                    // 3. MAGIA: Enviar el formulario de nuestro backend
                    // Esto llamará a CheckoutController.PlaceOrder y guardará el pedido en la BD
                    document.getElementById('order-form').submit();
                });
            },

            // 3. Si el usuario cancela o hay error
            onCancel: function (data) {
                console.log("Pago cancelado");
            },
            onError: function (err) {
                console.error("Error en PayPal", err);
                alert("Hubo un error al procesar el pago con PayPal.");
            }

        }).render('#paypal-button-container');
    </script>
}